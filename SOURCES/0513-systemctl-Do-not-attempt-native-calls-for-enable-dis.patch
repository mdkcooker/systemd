From 75b710994721fd9dd58715765368ef4cde15172b Mon Sep 17 00:00:00 2001
From: Colin Guthrie <colin@mageia.org>
Date: Mon, 13 Jan 2014 11:06:35 +0000
Subject: [PATCH 513/514] systemctl: Do not attempt native calls for
 enable/disable if sysvinit handleds all units.

If you have sysvinit compat enabled, it might deal with all the passed
in unit names leaving only a null termitated strv structure.

This cannot be iterated (sensibly) and thus we should just bail out
and not bother calling various native methods.

This should prevent a bogus warning regarding the lack of [Install]
sections in systemd units when enabling a sysvinit unit.
---
 src/systemctl/systemctl.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/src/systemctl/systemctl.c b/src/systemctl/systemctl.c
index db584b2..9ff4350 100644
--- a/src/systemctl/systemctl.c
+++ b/src/systemctl/systemctl.c
@@ -4437,6 +4437,11 @@ static int enable_unit(DBusConnection *bus, char **args) {
                 return r;
 
         if (!bus || avoid_bus()) {
+                /* If the sysvinit compat calls have handled everything we may
+                 * have none left to deal with natively... */
+                if (!mangled_names[0])
+                        goto finish;
+
                 if (streq(verb, "enable")) {
                         r = unit_file_enable(arg_scope, arg_runtime, arg_root, mangled_names, arg_force, &changes, &n_changes);
                         carries_install_info = r;
@@ -4480,6 +4485,11 @@ static int enable_unit(DBusConnection *bus, char **args) {
                 dbus_bool_t a, b;
                 DBusMessageIter iter, sub, sub2;
 
+                /* If the sysvinit compat calls have handled everything we may
+                 * have none left to deal with natively... */
+                if (!mangled_names[0])
+                        goto reload;
+
                 if (streq(verb, "enable")) {
                         method = "EnableUnitFiles";
                         expect_carries_install_info = true;
@@ -4598,6 +4608,7 @@ static int enable_unit(DBusConnection *bus, char **args) {
                         dbus_message_iter_next(&sub);
                 }
 
+reload:
                 /* Try to reload if enabeld */
                 if (!arg_no_reload)
                         r = daemon_reload(bus, args);
-- 
1.8.4.5

