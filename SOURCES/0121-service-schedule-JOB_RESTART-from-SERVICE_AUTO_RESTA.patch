From abcfff1b68123a8a7ac544b5e97ceb48f512ddb7 Mon Sep 17 00:00:00 2001
From: David Ward <david.ward@ll.mit.edu>
Date: Mon, 2 Apr 2012 23:45:35 -0400
Subject: [PATCH 121/125] service: schedule JOB_RESTART from
 SERVICE_AUTO_RESTART state

Fixes: https://bugs.freedesktop.org/show_bug.cgi?id=45511
---
 src/service.c |    9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/src/service.c b/src/service.c
index 8b5c0b0..bf2e0a9 100644
--- a/src/service.c
+++ b/src/service.c
@@ -2208,9 +2208,12 @@ static void service_enter_restart(Service *s) {
                         goto fail;
         }
 
-        service_enter_dead(s, SERVICE_SUCCESS, false);
-
-        if ((r = manager_add_job(UNIT(s)->manager, JOB_START, UNIT(s), JOB_FAIL, false, &error, NULL)) < 0)
+        /* Any units that are bound to this service must also be
+         * restarted. We use JOB_RESTART (instead of the more obvious
+         * JOB_START) here so that those dependency jobs will be added
+         * as well. */
+        r = manager_add_job(UNIT(s)->manager, JOB_RESTART, UNIT(s), JOB_FAIL, false, &error, NULL);
+        if (r < 0)
                 goto fail;
 
         log_debug("%s scheduled restart job.", UNIT(s)->id);
-- 
1.7.9.3

